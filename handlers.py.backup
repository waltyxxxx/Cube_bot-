#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
Handler functions for the Telegram bot commands and callbacks
"""

import logging
import datetime
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import ContextTypes
from user_data import (
    get_user_data, update_user_data, save_user_data,
    get_favorite_game, get_registration_date, get_games_played
)
from games import play_even_odd, play_higher_lower
from crypto_payments import create_deposit_invoice, get_user_balance
from constants import RESULTS_CHANNEL_ID

logger = logging.getLogger(__name__)

# Main menu keyboard
def get_main_keyboard():
    keyboard = [
        [
            InlineKeyboardButton("üë§–ü—Ä–æ—Ñ–∏–ª—å", callback_data="profile"),
            InlineKeyboardButton("üé≤–ò–ì–†–ê–¢–¨", callback_data="play")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)

# Play menu keyboard
def get_play_keyboard():
    keyboard = [
        [InlineKeyboardButton("üí∞ –ú–æ–π –±–∞–ª–∞–Ω—Å", callback_data="balance")],
        [InlineKeyboardButton("üí∏ –°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É", callback_data="bet")],
        [InlineKeyboardButton("üíµ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å", callback_data="deposit")],
        [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")]
    ]
    return InlineKeyboardMarkup(keyboard)

# Game selection keyboard
def get_game_keyboard():
    keyboard = [
        [InlineKeyboardButton("üé≤ –ß–µ—Ç/–Ω–µ—á–µ—Ç", callback_data="game_even_odd")],
        [InlineKeyboardButton("üìä –ë–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ", callback_data="game_higher_lower")],
        [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="play")],
    ]
    return InlineKeyboardMarkup(keyboard)

# Even/Odd game keyboard
def get_even_odd_keyboard(bet_amount=100):
    keyboard = [
        [
            InlineKeyboardButton(f"–ß–µ—Ç ({bet_amount} TON)", callback_data=f"even_odd_even_{bet_amount}"),
            InlineKeyboardButton(f"–ù–µ—á–µ—Ç ({bet_amount} TON)", callback_data=f"even_odd_odd_{bet_amount}")
        ],
        [
            InlineKeyboardButton("50 TON", callback_data="even_odd_bet_50"),
            InlineKeyboardButton("100 TON", callback_data="even_odd_bet_100"),
            InlineKeyboardButton("200 TON", callback_data="even_odd_bet_200")
        ],
        [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="bet")]
    ]
    return InlineKeyboardMarkup(keyboard)

# Higher/Lower game keyboard
def get_higher_lower_keyboard(bet_amount=100):
    keyboard = [
        [
            InlineKeyboardButton(f"–ë–æ–ª—å—à–µ 3 ({bet_amount} TON)", callback_data=f"higher_lower_higher_{bet_amount}"),
            InlineKeyboardButton(f"–ú–µ–Ω—å—à–µ 4 ({bet_amount} TON)", callback_data=f"higher_lower_lower_{bet_amount}")
        ],
        [
            InlineKeyboardButton("50 TON", callback_data="higher_lower_bet_50"),
            InlineKeyboardButton("100 TON", callback_data="higher_lower_bet_100"),
            InlineKeyboardButton("200 TON", callback_data="higher_lower_bet_200")
        ],
        [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="bet")]
    ]
    return InlineKeyboardMarkup(keyboard)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle the /start command."""
    user = update.effective_user
    user_id = user.id
    
    # Initialize user data if first time
    user_data = get_user_data(user_id)
    if not user_data:
        user_data = {
            "user_id": user_id,
            "username": user.username or "Anonymous",
            "registration_date": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "games_played": 0,
            "favorite_game": None,
            "balance": 0,
            "even_odd_games": 0,
            "higher_lower_games": 0,
            "last_activity": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        update_user_data(user_id, user_data)
        save_user_data()
    
    await update.effective_message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –≤–∞—Å –≤ –Ω–∞—à–µ–º –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–µ–º –∫–∞–∑–∏–Ω–æ! üé∞üí• –ü–æ–≥—Ä—É–∑–∏—Ç–µ—Å—å –≤ –º–∏—Ä –∞–∑–∞—Ä—Ç–∞ –∏ —É–¥–∞—á–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!",
        reply_markup=get_main_keyboard()
    )

async def profile_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle profile button click."""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    games_played = get_games_played(user_id)
    registration_date = get_registration_date(user_id)
    favorite_game = get_favorite_game(user_id)
    
    games_text = f"üéÆ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä: {games_played}" if games_played > 0 else "üéÆ –í—ã –µ—â–µ –Ω–µ —Å—ã–≥—Ä–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π –∏–≥—Ä—ã!"
    favorite_text = f"‚ù§Ô∏è –õ—é–±–∏–º—ã–π —Ä–µ–∂–∏–º: {favorite_game}" if favorite_game else "‚ù§Ô∏è –£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –ª—é–±–∏–º–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã."
    
    profile_text = (
        "üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\n"
        f"{games_text}\n\n"
        f"üìÖ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {registration_date}\n\n"
        f"{favorite_text}"
    )
    
    await query.edit_message_text(
        text=profile_text,
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")]
        ])
    )

async def play_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle play button click."""
    query = update.callback_query
    await query.answer()
    
    await query.edit_message_text(
        text="üéÆ –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_play_keyboard()
    )

async def show_balance(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show user balance."""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    balance = get_user_balance(user_id)
    
    await query.edit_message_text(
        text=f"üí∞ –í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {balance} TON",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("üíµ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å", callback_data="deposit")],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="play")]
        ])
    )

def get_deposit_keyboard():
    """Get deposit amount selection keyboard"""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üí∞ 10 TON", callback_data="deposit_amount_10")],
        [InlineKeyboardButton("üí∞ 50 TON", callback_data="deposit_amount_50")],
        [InlineKeyboardButton("üí∞ 100 TON", callback_data="deposit_amount_100")],
        [InlineKeyboardButton("üí∞ 500 TON", callback_data="deposit_amount_500")],
        [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="play")]
    ])

async def deposit_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle deposit button click."""
    query = update.callback_query
    await query.answer()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ —Å—É–º–º–∞
    if query.data.startswith("deposit_amount_"):
        amount = int(query.data.split("_")[-1])
        user_id = query.from_user.id
        invoice_url = await create_deposit_invoice(user_id, amount)
        
        # –í —Ä–µ–∂–∏–º–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –ø–æ–ª—É—á–∏–ª —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ create_deposit_invoice
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏
        balance = get_user_balance(user_id)
        
        await query.edit_message_text(
            text=f"‚úÖ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º: –í–∞—à –±–∞–ª–∞–Ω—Å –±—ã–ª –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {amount} TON!\n\nüí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {balance} TON",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å", callback_data="bet")],
                [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="play")]
            ])
        )
        
        # –û–±—ã—á–Ω—ã–π –∫–æ–¥ –¥–ª—è –Ω–∞—Å—Ç–æ—è—â–µ–π –æ–ø–ª–∞—Ç—ã –≤—ã–≥–ª—è–¥–µ–ª –±—ã —Ç–∞–∫ (—Å–µ–π—á–∞—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è):
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ª—É—á–∏–ª–∏ –ª–∏ –º—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π URL –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        if invoice_url.startswith("http"):
            # –£ –Ω–∞—Å –µ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π URL
            await query.edit_message_text(
                text=f"üíµ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ {amount} TON:\n\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ CryptoBot.",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton(f"üí∞ –û–ø–ª–∞—Ç–∏—Ç—å {amount} TON", url=invoice_url)],
                    [InlineKeyboardButton("‚óÄÔ∏è –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é —Å—É–º–º—É", callback_data="deposit")],
                    [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="play")]
                ])
            )
        else:
            # –ü–æ–ª—É—á–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤–º–µ—Å—Ç–æ URL
            await query.edit_message_text(
                text=f"‚ö†Ô∏è {invoice_url}\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="play")]
                ])
            )
        """
    else:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Å—É–º–º—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
        await query.edit_message_text(
            text="üíµ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å:\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:",
            reply_markup=get_deposit_keyboard()
        )

async def place_bet(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle bet button click and show game options."""
    query = update.callback_query
    await query.answer()
    
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {query.from_user.id} –≤—ã–±—Ä–∞–ª '–ò–≥—Ä–∞—Ç—å', –ø–æ–∫–∞–∑—ã–≤–∞—é –≤—ã–±–æ—Ä –∏–≥—Ä")
    
    try:
        await query.edit_message_text(
            text="üé≤ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∏–≥—Ä—ã:",
            reply_markup=get_game_keyboard()
        )
        logger.info("–≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –∏–≥—Ä—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —ç–∫—Ä–∞–Ω–∞ –≤—ã–±–æ—Ä–∞ –∏–≥—Ä—ã: {e}")

async def game_selection_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle game selection."""
    query = update.callback_query
    await query.answer()
    
    logger.info(f"–í—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º –∏–≥—Ä—ã: {query.data}")
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –∏–≥—Ä—ã –∏–∑ callback_data
    # game_even_odd -> ["game", "even_odd"]
    parts = query.data.split("_", 1)  # –†–∞–∑–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –ø–µ—Ä–≤–æ–º—É —Å–∏–º–≤–æ–ª—É '_'
    
    if len(parts) != 2:
        logger.error(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback_data: {query.data}")
        return
    
    prefix, game_type = parts
    
    if game_type == "even_odd":
        logger.info("–û—Ç–∫—Ä—ã–≤–∞—é –∏–≥—Ä—É –ß–µ—Ç/–Ω–µ—á–µ—Ç")
        try:
            await query.edit_message_text(
                text="üé≤ –ò–≥—Ä–∞ ¬´–ß–µ—Ç/–Ω–µ—á–µ—Ç¬ª\n\n–ü—Ä–∞–≤–∏–ª–∞: –í—ã–±–µ—Ä–∏—Ç–µ —á–µ—Ç –∏–ª–∏ –Ω–µ—á–µ—Ç. –ï—Å–ª–∏ –≤—ã–ø–∞–¥–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç - –≤—ã –≤—ã–∏–≥—Ä–∞–µ—Ç–µ –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ —Å—Ç–∞–≤–∫–∏!",
                reply_markup=get_even_odd_keyboard()
            )
            logger.info("–≠–∫—Ä–∞–Ω –∏–≥—Ä—ã –ß–µ—Ç/–Ω–µ—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —ç–∫—Ä–∞–Ω–∞ –∏–≥—Ä—ã –ß–µ—Ç/–Ω–µ—á–µ—Ç: {e}")
    
    elif game_type == "higher_lower":
        logger.info("–û—Ç–∫—Ä—ã–≤–∞—é –∏–≥—Ä—É –ë–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ")
        try:
            await query.edit_message_text(
                text="üìä –ò–≥—Ä–∞ ¬´–ë–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ¬ª\n\n–ü—Ä–∞–≤–∏–ª–∞: –í—ã–±–µ—Ä–∏—Ç–µ, –±—É–¥–µ—Ç –ª–∏ —á–∏—Å–ª–æ –±–æ–ª—å—à–µ 3 –∏–ª–∏ –º–µ–Ω—å—à–µ 4. –ï—Å–ª–∏ —É–≥–∞–¥–∞–µ—Ç–µ - –≤—ã–∏–≥—Ä–∞–µ—Ç–µ –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ —Å—Ç–∞–≤–∫–∏!",
                reply_markup=get_higher_lower_keyboard()
            )
            logger.info("–≠–∫—Ä–∞–Ω –∏–≥—Ä—ã –ë–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —ç–∫—Ä–∞–Ω–∞ –∏–≥—Ä—ã –ë–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ: {e}")
    
    else:
        logger.error(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∏–≥—Ä—ã: {game_type}")

async def even_odd_game_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle even/odd game."""
    query = update.callback_query
    await query.answer()
    
    parts = query.data.split("_")
    action = parts[2]
    
    # Handle bet amount change
    if action == "bet":
        bet_amount = int(parts[3])
        await query.edit_message_text(
            text=f"üé≤ –ò–≥—Ä–∞ ¬´–ß–µ—Ç/–Ω–µ—á–µ—Ç¬ª (—Å—Ç–∞–≤–∫–∞: {bet_amount} TON)\n\n–ü—Ä–∞–≤–∏–ª–∞: –í—ã–±–µ—Ä–∏—Ç–µ —á–µ—Ç –∏–ª–∏ –Ω–µ—á–µ—Ç. –ï—Å–ª–∏ –≤—ã–ø–∞–¥–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç - –≤—ã –≤—ã–∏–≥—Ä–∞–µ—Ç–µ –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ —Å—Ç–∞–≤–∫–∏!",
            reply_markup=get_even_odd_keyboard(bet_amount)
        )
        return
    
    # Handle actual bet
    user_id = query.from_user.id
    bet_choice = action  # "even" or "odd"
    bet_amount = int(parts[3])
    
    # Check if user has enough balance
    balance = get_user_balance(user_id)
    if balance < bet_amount:
        await query.edit_message_text(
            text=f"‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á–µ—Ç–µ. –í–∞—à –±–∞–ª–∞–Ω—Å: {balance} TON",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üíµ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å", callback_data="deposit")],
                [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="bet")]
            ])
        )
        return
    
    # Play the game
    result = await play_even_odd(update, context, user_id, bet_choice, bet_amount)
    
    # Update user data
    user_data = get_user_data(user_id)
    user_data["games_played"] += 1
    user_data["even_odd_games"] += 1
    
    # Set as favorite game if this is the most played game
    if user_data.get("even_odd_games", 0) > user_data.get("higher_lower_games", 0):
        user_data["favorite_game"] = "–ß–µ—Ç/–Ω–µ—á–µ—Ç"
    
    update_user_data(user_id, user_data)
    save_user_data()
    
    # Send results to the user and ask if they want to play again
    await query.edit_message_text(
        text=result["message"],
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("üé≤ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞", callback_data="game_even_odd")],
            [InlineKeyboardButton("‚óÄÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é", callback_data="play")]
        ])
    )
    
    # Post results to channel if configured
    if RESULTS_CHANNEL_ID:
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª
            channel_message = await context.bot.send_message(
                chat_id=RESULTS_CHANNEL_ID,
                text=result["channel_message"]
            )
            
            # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–Ω–∞–ª –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º RESULTS_CHANNEL_ID –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Å—Å—ã–ª–∫–∏
            channel_id_for_link = str(RESULTS_CHANNEL_ID).replace("-100", "")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –∫–∞–Ω–∞–ª
            await context.bot.send_message(
                chat_id=update.effective_chat.id,
                text="üéÆ –•–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∏–≥—Ä–æ–≤–æ–º –∫–∞–Ω–∞–ª–µ?",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton(
                        "üëÄ –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –≤ –∫–∞–Ω–∞–ª–µ", 
                        url=f"https://t.me/c/{channel_id_for_link}/{channel_message.message_id}"
                    )]
                ])
            )
            logger.info(f"Sent channel link to user {user_id}")
        except Exception as e:
            logger.error(f"Failed to send message to results channel: {e}")

async def higher_lower_game_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle higher/lower game."""
    query = update.callback_query
    await query.answer()
    
    parts = query.data.split("_")
    action = parts[2]
    
    # Handle bet amount change
    if action == "bet":
        bet_amount = int(parts[3])
        await query.edit_message_text(
            text=f"üìä –ò–≥—Ä–∞ ¬´–ë–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ¬ª (—Å—Ç–∞–≤–∫–∞: {bet_amount} TON)\n\n–ü—Ä–∞–≤–∏–ª–∞: –í—ã–±–µ—Ä–∏—Ç–µ, –±—É–¥–µ—Ç –ª–∏ —á–∏—Å–ª–æ –±–æ–ª—å—à–µ 3 –∏–ª–∏ –º–µ–Ω—å—à–µ 4. –ï—Å–ª–∏ —É–≥–∞–¥–∞–µ—Ç–µ - –≤—ã–∏–≥—Ä–∞–µ—Ç–µ –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ —Å—Ç–∞–≤–∫–∏!",
            reply_markup=get_higher_lower_keyboard(bet_amount)
        )
        return
    
    # Handle actual bet
    user_id = query.from_user.id
    bet_choice = action  # "higher" or "lower"
    bet_amount = int(parts[3])
    
    # Check if user has enough balance
    balance = get_user_balance(user_id)
    if balance < bet_amount:
        await query.edit_message_text(
            text=f"‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á–µ—Ç–µ. –í–∞—à –±–∞–ª–∞–Ω—Å: {balance} TON",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üíµ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å", callback_data="deposit")],
                [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="bet")]
            ])
        )
        return
    
    # Play the game
    result = await play_higher_lower(update, context, user_id, bet_choice, bet_amount)
    
    # Update user data
    user_data = get_user_data(user_id)
    user_data["games_played"] += 1
    user_data["higher_lower_games"] += 1
    
    # Set as favorite game if this is the most played game
    if user_data.get("higher_lower_games", 0) > user_data.get("even_odd_games", 0):
        user_data["favorite_game"] = "–ë–æ–ª—å—à–µ/–º–µ–Ω—å—à–µ"
    
    update_user_data(user_id, user_data)
    save_user_data()
    
    # Send results to the user and ask if they want to play again
    await query.edit_message_text(
        text=result["message"],
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("üé≤ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞", callback_data="game_higher_lower")],
            [InlineKeyboardButton("‚óÄÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é", callback_data="play")]
        ])
    )
    
    # Post results to channel if configured
    if RESULTS_CHANNEL_ID:
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª
            channel_message = await context.bot.send_message(
                chat_id=RESULTS_CHANNEL_ID,
                text=result["channel_message"]
            )
            
            # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–Ω–∞–ª –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º RESULTS_CHANNEL_ID –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Å—Å—ã–ª–∫–∏
            channel_id_for_link = str(RESULTS_CHANNEL_ID).replace("-100", "")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –∫–∞–Ω–∞–ª
            await context.bot.send_message(
                chat_id=update.effective_chat.id,
                text="üéÆ –•–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∏–≥—Ä–æ–≤–æ–º –∫–∞–Ω–∞–ª–µ?",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton(
                        "üëÄ –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –≤ –∫–∞–Ω–∞–ª–µ", 
                        url=f"https://t.me/c/{channel_id_for_link}/{channel_message.message_id}"
                    )]
                ])
            )
            logger.info(f"Sent channel link to user {user_id}")
        except Exception as e:
            logger.error(f"Failed to send message to results channel: {e}")

async def cancel_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle cancel button click or unknown text messages."""
    if update.callback_query:
        query = update.callback_query
        await query.answer()
        await query.edit_message_text(
            text="–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
            reply_markup=get_main_keyboard()
        )
    else:
        await update.message.reply_text(
            "–ù–µ –ø–æ–Ω–∏–º–∞—é —ç—Ç—É –∫–æ–º–∞–Ω–¥—É. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.",
            reply_markup=get_main_keyboard()
        )

async def chat_member_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle bot being added to or removed from a chat"""
    my_chat_member = update.my_chat_member
    chat = my_chat_member.chat
    new_status = my_chat_member.new_chat_member.status
    old_status = my_chat_member.old_chat_member.status
    
    # –ë–æ—Ç –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞–Ω–∞–ª –∏–ª–∏ –≥—Ä—É–ø–ø—É
    if old_status in ["left", "kicked"] and new_status in ["member", "administrator"]:
        if chat.type in ["channel", "supergroup", "group"]:
            logger.info(f"–ë–æ—Ç –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ {chat.type} {chat.title} (ID: {chat.id})")
            
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª –∏–ª–∏ –≥—Ä—É–ø–ø—É
            welcome_text = (
                f"üé∞ <b>–ö–∞–∑–∏–Ω–æ-–±–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ {chat.title}!</b> üé∞\n\n"
                f"‚úÖ –¢–µ–ø–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä –±—É–¥—É—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å—Å—è –∑–¥–µ—Å—å.\n\n"
                f"üì± –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä–∞—Ç—å, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ª–∏—á–∫—É —Å –±–æ—Ç–æ–º."
            )
            
            try:
                await context.bot.send_message(
                    chat_id=chat.id,
                    text=welcome_text,
                    parse_mode="HTML"
                )
                logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ {chat.type} {chat.title}")
                
                # –ï—Å–ª–∏ —ç—Ç–æ –∫–∞–Ω–∞–ª –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                if RESULTS_CHANNEL_ID is None or str(chat.id) == RESULTS_CHANNEL_ID:
                    logger.info(f"–ö–∞–Ω–∞–ª {chat.id} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ –∫–∞–Ω–∞–ª –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
    
    # –ë–æ—Ç –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–∑ –∫–∞–Ω–∞–ª–∞ –∏–ª–∏ –≥—Ä—É–ø–ø—ã
    elif new_status in ["left", "kicked"] and old_status in ["member", "administrator"]:
        logger.info(f"–ë–æ—Ç –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–∑ {chat.type} {chat.title} (ID: {chat.id})")
